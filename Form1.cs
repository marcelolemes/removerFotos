using System;
using System.Drawing;
using System.Collections;
using System.ComponentModel;
using System.Windows.Forms;
using System.Data;
using System.Collections.Generic;
using System.IO;

// Written by: Alex Farber
//
// alexm@cmt.co.il
// Modify by: Marcelo Lemes
//lemmarcelo@gmail.com


namespace DropFiles1
{
	/// <summary>
    /// Windows form application which opens files
    /// using File - Open menu item or dragged from
    /// Windows Explorer.
    /// Class DragDropManager is used to implement
    /// drag-and-drop feature.
    /// 
    /// </summary>
	public class Form1 : System.Windows.Forms.Form, IDropFileTarget
	{
        #region Members

        private DragDropManager m_DragDropManager;

        #endregion

        #region Members Generated by Designer

        private System.Windows.Forms.MainMenu mainMenu1;
        private System.Windows.Forms.MenuItem menuItem1;
        private System.Windows.Forms.MenuItem menuItem3;
        private System.Windows.Forms.MenuItem mnuFileExit;
        private System.Windows.Forms.MenuItem menuItem2;
        private System.Windows.Forms.MenuItem mnuHelpAbout;
        private System.Windows.Forms.ListBox lstFiles;

        #endregion
        private CheckBox checkBox1;
        private ProgressBar progressBar1;
        private FolderBrowserDialog camCurso;
        private IContainer components;
        String[] DiretorioCur = new string[] { };

        #region Constructor, Destructor

		public Form1()
		{
			//
			// Required for Windows Form Designer support
			//
			InitializeComponent();

			//
			// TODO: Add any constructor code after InitializeComponent call
			//
		}

		/// <summary>
		/// Clean up any resources being used.
		/// </summary>
		protected override void Dispose( bool disposing )
		{
			if( disposing )
			{
				if (components != null) 
				{
					components.Dispose();
				}
			}
			base.Dispose( disposing );
		}

        #endregion

		#region Windows Form Designer generated code
		/// <summary>
		/// Required method for Designer support - do not modify
		/// the contents of this method with the code editor.
		/// </summary>
		private void InitializeComponent()
		{
            this.components = new System.ComponentModel.Container();
            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(Form1));
            this.mainMenu1 = new System.Windows.Forms.MainMenu(this.components);
            this.menuItem1 = new System.Windows.Forms.MenuItem();
            this.menuItem3 = new System.Windows.Forms.MenuItem();
            this.mnuFileExit = new System.Windows.Forms.MenuItem();
            this.menuItem2 = new System.Windows.Forms.MenuItem();
            this.mnuHelpAbout = new System.Windows.Forms.MenuItem();
            this.lstFiles = new System.Windows.Forms.ListBox();
            this.checkBox1 = new System.Windows.Forms.CheckBox();
            this.progressBar1 = new System.Windows.Forms.ProgressBar();
            this.camCurso = new System.Windows.Forms.FolderBrowserDialog();
            this.SuspendLayout();
            // 
            // mainMenu1
            // 
            this.mainMenu1.MenuItems.AddRange(new System.Windows.Forms.MenuItem[] {
            this.menuItem1,
            this.menuItem2});
            // 
            // menuItem1
            // 
            this.menuItem1.Index = 0;
            this.menuItem1.MenuItems.AddRange(new System.Windows.Forms.MenuItem[] {
            this.menuItem3,
            this.mnuFileExit});
            this.menuItem1.Text = "Arquivo";
            this.menuItem1.Click += new System.EventHandler(this.menuItem1_Click);
            // 
            // menuItem3
            // 
            this.menuItem3.Index = 0;
            this.menuItem3.Text = "-";
            // 
            // mnuFileExit
            // 
            this.mnuFileExit.Index = 1;
            this.mnuFileExit.Text = "Sair";
            this.mnuFileExit.Click += new System.EventHandler(this.mnuFileExit_Click);
            // 
            // menuItem2
            // 
            this.menuItem2.Index = 1;
            this.menuItem2.MenuItems.AddRange(new System.Windows.Forms.MenuItem[] {
            this.mnuHelpAbout});
            this.menuItem2.Text = "Ajuda";
            // 
            // mnuHelpAbout
            // 
            this.mnuHelpAbout.Index = 0;
            this.mnuHelpAbout.Text = "Sobre";
            this.mnuHelpAbout.Click += new System.EventHandler(this.mnuHelpAbout_Click);
            // 
            // lstFiles
            // 
            this.lstFiles.Anchor = ((System.Windows.Forms.AnchorStyles)((((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Bottom) 
            | System.Windows.Forms.AnchorStyles.Left) 
            | System.Windows.Forms.AnchorStyles.Right)));
            this.lstFiles.ItemHeight = 16;
            this.lstFiles.Location = new System.Drawing.Point(7, 17);
            this.lstFiles.Name = "lstFiles";
            this.lstFiles.Size = new System.Drawing.Size(459, 212);
            this.lstFiles.TabIndex = 0;
            this.lstFiles.SelectedIndexChanged += new System.EventHandler(this.lstFiles_SelectedIndexChanged);
            // 
            // checkBox1
            // 
            this.checkBox1.AutoSize = true;
            this.checkBox1.Location = new System.Drawing.Point(12, 253);
            this.checkBox1.Name = "checkBox1";
            this.checkBox1.Size = new System.Drawing.Size(200, 20);
            this.checkBox1.TabIndex = 1;
            this.checkBox1.Text = "Remover de todos os álbuns";
            this.checkBox1.UseVisualStyleBackColor = true;
            this.checkBox1.CheckedChanged += new System.EventHandler(this.checkBox1_CheckedChanged);
            this.checkBox1.CheckStateChanged += new System.EventHandler(this.checkBox1_CheckStateChanged);
            // 
            // progressBar1
            // 
            this.progressBar1.Location = new System.Drawing.Point(218, 247);
            this.progressBar1.Name = "progressBar1";
            this.progressBar1.Size = new System.Drawing.Size(248, 23);
            this.progressBar1.TabIndex = 2;
            this.progressBar1.UseWaitCursor = true;
            // 
            // camCurso
            // 
            this.camCurso.RootFolder = System.Environment.SpecialFolder.MyComputer;
            this.camCurso.ShowNewFolderButton = false;
            this.camCurso.HelpRequest += new System.EventHandler(this.camCurso_HelpRequest);
            // 
            // Form1
            // 
            this.AutoScaleBaseSize = new System.Drawing.Size(6, 15);
            this.AutoSize = true;
            this.BackgroundImageLayout = System.Windows.Forms.ImageLayout.None;
            this.ClientSize = new System.Drawing.Size(472, 272);
            this.Controls.Add(this.progressBar1);
            this.Controls.Add(this.checkBox1);
            this.Controls.Add(this.lstFiles);
            this.Cursor = System.Windows.Forms.Cursors.Hand;
            this.Font = new System.Drawing.Font("Microsoft Sans Serif", 9.75F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.Icon = ((System.Drawing.Icon)(resources.GetObject("$this.Icon")));
            this.ImeMode = System.Windows.Forms.ImeMode.Off;
            this.KeyPreview = true;
            this.Menu = this.mainMenu1;
            this.MinimizeBox = false;
            this.Name = "Form1";
            this.Text = "Remover (teste)";
            this.TopMost = true;
            this.Load += new System.EventHandler(this.Form1_Load);
            this.ResumeLayout(false);
            this.PerformLayout();

        }
		#endregion

        #region Main Function

		/// <summary>
		/// The main entry point for the application.
		/// </summary>
		[STAThread]
		static void Main() 
		{
			Application.Run(new Form1());
		}

        #endregion

        #region Other Functions


        /// <summary>
        /// Open file or files passed as array.
        /// 
        /// Called from mnuFileOpen_Click or from (when user selects
        /// File - Open menu item) or from DragDropManager
        /// (when user drops files from Windows Explorer)
        /// </summary>
        /// <param name="a">Array of file names</param>
        public void OpenFiles(Array a)
        {
            // If our application can open only one file, we can process
            // here only first element of array or give some error message
            // in the case array contains more than one file.
            //
            // In this sample I allow to open number of files showing 
            // their names in list box.
            
            string sError = "";
            string sFile;
            string valorAlbumAtual="";
            string valorFoto="";
            List<string> arquivosPesquisa = new List<string>();
            List<string> valorPath = new List<string>();
            string targetPath="";
            lstFiles.Items.Clear();
            
            // process all files in array
            for ( int i = 0; i < a.Length; i++ )
            {
                progressBar1.Value = 0;
                if (!checkBox1.Checked)
                {

                    sFile = a.GetValue(i).ToString();           // file name

                    // Check file name
                    // (Let's say we don't accept non-existing files or directories)
                    FileInfo info = new FileInfo(sFile);


                    if (!info.Exists)
                    {
                        sError += "\nNome do arquivo incorreto " + sFile + " impossível abrí-lo";
                    }
                    else
                    {
                        valorAlbumAtual = a.GetValue(i).ToString();           // file name
                        valorPath.AddRange(valorAlbumAtual.Split('\\'));

                        valorFoto = valorPath[valorPath.Count - 1];
                        valorPath.Remove(valorFoto);
                        valorAlbumAtual = valorPath[valorPath.Count - 1];
                        valorPath.Remove(valorAlbumAtual);

                        lstFiles.Items.Add(valorFoto + " removido");
                        foreach (String s in valorPath)
                        {
                            targetPath = targetPath + s + "\\";
                        }


                        targetPath = targetPath + "Removidas\\" + valorAlbumAtual + "\\";

                        lstFiles.Items.Add("Removida para o destino " + targetPath + valorFoto);

                        try
                        {
                            if (!File.Exists(targetPath))
                            {
                                // This statement ensures that the file is created,
                                // but the handle is not kept.
                                try
                                {
                                    System.IO.Directory.CreateDirectory(targetPath);
                                }
                                catch
                                {
                                    MessageBox.Show("Falha ao criar pasta removidas");
                                }
                            }

                            System.IO.File.Move(sFile, targetPath + valorFoto);
                        }
                        catch
                        {

                            MessageBox.Show("Falha ao mover arquivo");
                        }
                        finally
                        {




                            valorPath.Clear();
                            valorAlbumAtual = "";
                            valorFoto = "";
                            targetPath = "";

                        }
                    }
                }

                else { // caso esteja assinalada a opção de remover em todos os albuns


                   

                    sFile = a.GetValue(i).ToString();           // file name

                    // Check file name
                    // (Let's say we don't accept non-existing files or directories)
                    FileInfo info = new FileInfo(sFile);


                    if (!info.Exists)
                    {
                        sError += "\nNome do arquivo incorreto " + sFile + " impossível abrí-lo";
                    }
                    else
                    {
                  
                        valorAlbumAtual = a.GetValue(i).ToString();           // file name
                        valorPath.AddRange(valorAlbumAtual.Split('\\'));

                        valorFoto = valorPath[valorPath.Count - 1];
                        foreach(String d in DiretorioCur){
                        arquivosPesquisa.AddRange(Directory.GetFileSystemEntries(d,valorFoto,SearchOption.AllDirectories));
                        valorPath.Clear();
                    }

                    //    MessageBox.Show("Qtd de arquivos encontrada "+arquivosPesquisa.Count);
                        
                        foreach(String f in arquivosPesquisa){

                            valorAlbumAtual = f;
                        valorPath.AddRange(valorAlbumAtual.Split('\\'));

                        valorFoto = valorPath[valorPath.Count - 1];
                        valorPath.Remove(valorFoto);
                        valorAlbumAtual = valorPath[valorPath.Count - 1];
                        valorPath.Remove(valorAlbumAtual);
                        // pesquisa em todo o curso a tal da foto
                        

                        lstFiles.Items.Add(valorFoto + " REMOVIDO!");
                        foreach (String s in valorPath)
                        {
                            targetPath = targetPath + s + "\\";
                        }


                        targetPath = targetPath + "Removidas\\" + valorAlbumAtual + "\\";

                        lstFiles.Items.Add("Removida para o destino " + targetPath + valorFoto);

                        try
                        {
                            if (!File.Exists(targetPath))
                            {
                                // This statement ensures that the file is created,
                                // but the handle is not kept.
                                try
                                {
                                    System.IO.Directory.CreateDirectory(targetPath);
                                }
                                catch
                                {
                                    MessageBox.Show("Falha ao criar pasta removidas "+targetPath);
                                }
                            }
                            if (!File.Exists(targetPath + valorFoto))
                            System.IO.File.Move(f, targetPath + valorFoto);
                            progressBar1.Value += (100 / arquivosPesquisa.Count);
                        }
                        catch
                        {

                            MessageBox.Show("Falha ao mover arquivo");
                        }
                        finally
                        {
                            
                            valorPath.Clear();
                            valorAlbumAtual = "";
                            valorFoto = "";
                            targetPath = "";

                        }
                    }
                    }
                
                }
            // fim do laço FOR
            }

            // Drop directory from Explorer to this form to see error message:
            if ( sError.Length > 0 )
                MessageBox.Show(this, sError, "Erro ao abrir arquivo");
        }


        #endregion

        #region Message Handlers

        /// <summary>
        /// Initialize Drag-Drop manager
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void Form1_Load(object sender, System.EventArgs e)
        {
            m_DragDropManager = new DragDropManager();
            m_DragDropManager.Parent = this;
        }


        /// <summary>
        /// File - Exit menu item
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void mnuFileExit_Click(object sender, System.EventArgs e)
        {
            this.Close();
        }

        /// <summary>
        /// Show About Box
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void mnuHelpAbout_Click(object sender, System.EventArgs e)
        {
            MessageBox.Show(
                this,
                "Programa feito para remover fotos\n" + 
                "Class DragDropManager is used to implement Drag-Drop feature",
                "Fase de testes!!!");
        
        }

        /// <summary>
        /// File - Open menu item
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void mnuFileOpen_Click(object sender, System.EventArgs e)
        {
            
            // Show Open File dialog

            /*
            OpenFileDialog openDlg = new OpenFileDialog();
            openDlg.Filter  = "All Files (*.*)|*.*";

            openDlg.InitialDirectory = Directory.GetCurrentDirectory();
            openDlg.FileName = "" ;
            openDlg.CheckFileExists = true;
            openDlg.CheckPathExists = true;
            openDlg.Multiselect = true;

            if ( openDlg.ShowDialog() != DialogResult.OK )
                return;

            // Call OpenFiles function passing array of strings to it
            OpenFiles(openDlg.FileNames);
             * */
        }


        #endregion

        private void lstFiles_SelectedIndexChanged(object sender, EventArgs e)
        {

        }

        private void menuItem1_Click(object sender, EventArgs e)
        {

        }

        private void checkBox1_CheckedChanged(object sender, EventArgs e)
        {
            
            
                
            
        }

        private void checkBox1_CheckStateChanged(object sender, EventArgs e)
        {
            if (camCurso.ShowDialog() == DialogResult.OK)
            {
                try
                {
                    DiretorioCur = Directory.GetDirectories(camCurso.SelectedPath, "20*");
                    if (DiretorioCur.Length <= 0)
                    {
                        MessageBox.Show("Pasta sem álbum algum, selecione outra pasta por favor!");
                        checkBox1.Checked = false;
                    }
                    else
                        checkBox1.Checked = true;
                }
                catch
                {
                    MessageBox.Show("Pasta sem álbum algum, selecione outra pasta por favor!");
                    checkBox1.Checked = false;
                }

            }
            else
            {
                checkBox1.Checked = false;
                MessageBox.Show("Selecione uma pasta onde será feita a pesquisa");

            }
        }

        private void camCurso_HelpRequest(object sender, EventArgs e)
        {

        }



	}
}
